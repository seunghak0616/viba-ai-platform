name: VIBA AI ì¢…í•© í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸

on:
  push:
    branches: [main, development]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ ì‹¤í–‰

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  POSTGRES_VERSION: '15'

jobs:
  # ============================================================================
  # 1. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
  # ============================================================================
  unit-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        component: [nlp, design-theory, bim-generation, performance-analysis, theory-application]
      fail-fast: false
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install Node.js ì˜ì¡´ì„±
        run: |
          npm ci
          cd nlp-engine && npm ci
          
      - name: Install Python ì˜ì¡´ì„±
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r nlp-engine/requirements.txt
          
      - name: Download AI ëª¨ë¸ (ìºì‹œ)
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/huggingface
            nlp-engine/models
          key: ai-models-${{ hashFiles('nlp-engine/model_config.json') }}
          
      - name: Run ${{ matrix.component }} ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ§ª Running unit tests for ${{ matrix.component }}"
          npm run test:unit:${{ matrix.component }}
          
      - name: Run Python ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        run: |
          cd nlp-engine
          python -m pytest tests/unit/${{ matrix.component }}/ -v --tb=short
          
      - name: Upload í…ŒìŠ¤íŠ¸ ê²°ê³¼
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results-${{ matrix.component }}
          path: |
            test-results/
            coverage/
            
      - name: Upload í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage/lcov.info
          flags: unit-${{ matrix.component }}

  # ============================================================================
  # 2. í†µí•© í…ŒìŠ¤íŠ¸
  # ============================================================================
  integration-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:${{ env.POSTGRES_VERSION }}
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_DB: viba_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
          
      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install ì˜ì¡´ì„±
        run: |
          npm ci
          cd nlp-engine && npm ci && pip install -r requirements.txt
          
      - name: Setup í…ŒìŠ¤íŠ¸ ë°ì´í„°ë² ì´ìŠ¤
        run: |
          npm run db:reset:test
          npm run data:seed:test
          
      - name: Run ë‹¤ì¤‘ ì—ì´ì „íŠ¸ í†µí•© í…ŒìŠ¤íŠ¸
        env:
          DATABASE_URL: postgresql://postgres:testpassword@localhost:5432/viba_test
          REDIS_URL: redis://localhost:6379
        run: |
          echo "ğŸ¤– Running multi-agent integration tests"
          npm run test:integration:multi-agent
          
      - name: Run MCP í†µí•© í…ŒìŠ¤íŠ¸
        env:
          NOTION_API_KEY: ${{ secrets.NOTION_TEST_API_KEY }}
          TEST_MODE: true
        run: |
          echo "ğŸ”— Running MCP integration tests"
          npm run test:integration:mcp
          
      - name: Upload í†µí•© í…ŒìŠ¤íŠ¸ ê²°ê³¼
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: test-results/integration/

  # ============================================================================
  # 3. ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  # ============================================================================
  performance-tests:
    needs: unit-tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install K6 (ë¶€í•˜ í…ŒìŠ¤íŠ¸)
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6
          
      - name: Install ì˜ì¡´ì„±
        run: |
          npm ci
          pip install -r requirements.txt
          
      - name: Run AI ëª¨ë¸ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸš€ Running AI model performance tests"
          python nlp-engine/tests/performance/model_performance_test.py
          
      - name: Run API ë¶€í•˜ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ“Š Running API load tests"
          k6 run tests/performance/api_load_test.js
          
      - name: Upload ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ê²°ê³¼
        uses: actions/upload-artifact@v3
        with:
          name: performance-test-results
          path: |
            test-results/performance/
            performance-reports/

  # ============================================================================
  # 4. E2E í…ŒìŠ¤íŠ¸ (ì¢…ë‹¨ê°„)
  # ============================================================================
  e2e-tests:
    needs: [unit-tests, integration-tests]
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install ì˜ì¡´ì„±
        run: npm ci
        
      - name: Install Playwright
        run: npx playwright install --with-deps
        
      - name: Build í”„ë¡ íŠ¸ì—”ë“œ
        run: npm run build
        
      - name: Start ì „ì²´ ì‹œìŠ¤í…œ
        run: |
          npm run start:test-env &
          sleep 30  # ì‹œìŠ¤í…œ ì‹œì‘ ëŒ€ê¸°
          
      - name: Run E2E í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ­ Running end-to-end tests"
          npx playwright test tests/e2e/
          
      - name: Upload E2E í…ŒìŠ¤íŠ¸ ê²°ê³¼
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: e2e-test-results
          path: |
            test-results/e2e/
            playwright-report/

  # ============================================================================
  # 5. ë³´ì•ˆ ìŠ¤ìº”
  # ============================================================================
  security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Run ì˜ì¡´ì„± ë³´ì•ˆ ìŠ¤ìº”
        run: |
          npm audit --audit-level high
          pip-audit
          
      - name: Run ì½”ë“œ ë³´ì•ˆ ìŠ¤ìº” (Semgrep)
        uses: returntocorp/semgrep-action@v1
        with:
          config: >-
            p/security-audit
            p/secrets
            p/typescript
            p/python
            
      - name: Upload ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-results
          path: security-reports/

  # ============================================================================
  # 6. ì½”ë“œ í’ˆì§ˆ ë¶„ì„
  # ============================================================================
  code-quality:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarQubeë¥¼ ìœ„í•œ ì „ì²´ íˆìŠ¤í† ë¦¬
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install ì˜ì¡´ì„±
        run: npm ci
        
      - name: Run ESLint
        run: npm run lint:check
        
      - name: Run Prettier ì²´í¬
        run: npm run format:check
        
      - name: Run TypeScript íƒ€ì… ì²´í¬
        run: npm run type-check
        
      - name: SonarQube ìŠ¤ìº”
        uses: sonarqube-quality-gate-action@master
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ============================================================================
  # 7. ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
  # ============================================================================
  generate-report:
    needs: [unit-tests, integration-tests, performance-tests, e2e-tests, security-scan, code-quality]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Download ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼
        uses: actions/download-artifact@v3
        
      - name: Setup Python (ë¦¬í¬íŠ¸ ìƒì„±ìš©)
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install ë¦¬í¬íŠ¸ ìƒì„± ë„êµ¬
        run: pip install jinja2 matplotlib pandas
        
      - name: Generate ì¢…í•© í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸
        run: |
          python scripts/generate_test_report.py \
            --unit-results unit-test-results-*/ \
            --integration-results integration-test-results/ \
            --performance-results performance-test-results/ \
            --e2e-results e2e-test-results/ \
            --security-results security-scan-results/ \
            --output comprehensive-test-report.html
            
      - name: Upload ì¢…í•© ë¦¬í¬íŠ¸
        uses: actions/upload-artifact@v3
        with:
          name: comprehensive-test-report
          path: |
            comprehensive-test-report.html
            test-summary.json
            
      - name: Comment PR with í…ŒìŠ¤íŠ¸ ê²°ê³¼
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const summary = JSON.parse(fs.readFileSync('test-summary.json', 'utf8'));
            
            const comment = `
            ## ğŸ¤– VIBA AI í…ŒìŠ¤íŠ¸ ê²°ê³¼
            
            ### ğŸ“Š ì „ì²´ ìš”ì•½
            - **ì´ í…ŒìŠ¤íŠ¸**: ${summary.total_tests}
            - **ì„±ê³µ**: ${summary.passed_tests} âœ…
            - **ì‹¤íŒ¨**: ${summary.failed_tests} âŒ
            - **ì„±ê³µë¥ **: ${summary.success_rate}%
            
            ### ğŸ§ª ì»´í¬ë„ŒíŠ¸ë³„ ê²°ê³¼
            ${Object.entries(summary.components).map(([component, result]) => 
              `- **${component}**: ${result.status} (${result.accuracy})`
            ).join('\n')}
            
            ### ğŸ¯ AI ì„±ëŠ¥ ì§€í‘œ
            - **NLP ì •í™•ë„**: ${summary.ai_metrics.nlp_accuracy}%
            - **ì„¤ê³„ì´ë¡  ì ìš©**: ${summary.ai_metrics.design_theory_accuracy}%
            - **BIM ìƒì„± ì •í™•ë„**: ${summary.ai_metrics.bim_generation_accuracy}%
            
            [ğŸ“‹ ìƒì„¸ ë¦¬í¬íŠ¸ ë³´ê¸°](${summary.report_url})
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ============================================================================
  # 8. ë°°í¬ ì¤€ë¹„ (main ë¸Œëœì¹˜ë§Œ)
  # ============================================================================
  deploy-staging:
    needs: [unit-tests, integration-tests, performance-tests, e2e-tests, security-scan, code-quality]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: Install ì˜ì¡´ì„±
        run: npm ci
        
      - name: Build í”„ë¡œë•ì…˜
        run: npm run build:production
        
      - name: Build Docker ì´ë¯¸ì§€
        run: |
          docker build -t viba-ai:${{ github.sha }} .
          docker build -t viba-nlp:${{ github.sha }} ./nlp-engine
          
      - name: Deploy to Staging
        run: |
          echo "ğŸš€ Deploying to staging environment"
          # ì‹¤ì œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” í™˜ê²½ì— ë”°ë¼ êµ¬ì„±
          
      - name: Run Smoke í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ’¨ Running smoke tests on staging"
          npm run test:smoke:staging